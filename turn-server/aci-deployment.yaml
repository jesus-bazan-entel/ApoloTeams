apiVersion: '2021-10-01'
location: eastus2
name: apolo-turn
type: Microsoft.ContainerInstance/containerGroups
properties:
  osType: Linux
  restartPolicy: Always
  ipAddress:
    type: Public
    dnsNameLabel: apolo-turn
    ports:
      - port: 3478
        protocol: UDP
      - port: 49152
        protocol: UDP
      - port: 49153
        protocol: UDP
      - port: 49154
        protocol: UDP
      - port: 49155
        protocol: UDP
  containers:
    - name: coturn
      properties:
        image: coturn/coturn:latest
        resources:
          requests:
            cpu: 0.5
            memoryInGb: 0.5
        ports:
          - port: 3478
            protocol: UDP
          - port: 49152
            protocol: UDP
          - port: 49153
            protocol: UDP
          - port: 49154
            protocol: UDP
          - port: 49155
            protocol: UDP
        command:
          - /bin/sh
          - -c
          - >-
            i=0; EXTERNAL_IP="";
            while [ $i -lt 15 ]; do
            EXTERNAL_IP=$(nslookup apolo-turn.eastus2.azurecontainer.io 2>/dev/null | grep -v '#' | grep 'Address' | sed 's/.*: *//');
            if [ -n "$EXTERNAL_IP" ]; then break; fi;
            i=$((i+1)); echo "Waiting for DNS (attempt $i)..."; sleep 2;
            done;
            echo "Detected external IP: $EXTERNAL_IP";
            if [ -n "$EXTERNAL_IP" ]; then
            exec turnserver -a -v -n -L 0.0.0.0 --listening-port 3478 --min-port 49152 --max-port 49155 -r apolo.teams --user apolo:ApoloTurnSecure2026 --log-file stdout --no-cli --fingerprint --no-multicast-peers --no-tls --no-dtls -X "$EXTERNAL_IP";
            else
            echo "WARNING: Could not detect external IP";
            exec turnserver -a -v -n -L 0.0.0.0 --listening-port 3478 --min-port 49152 --max-port 49155 -r apolo.teams --user apolo:ApoloTurnSecure2026 --log-file stdout --no-cli --fingerprint --no-multicast-peers --no-tls --no-dtls;
            fi
