# =============================================================================
# Deploy to Azure Container Apps
# =============================================================================
# Triggers on push to main (after CI passes)
# Builds Docker image → pushes to Azure Container Registry → deploys to Container Apps
#
# Required GitHub Secrets:
#   AZURE_CLIENT_ID           - Service principal client/app ID
#   AZURE_CLIENT_SECRET       - Service principal client secret
#   AZURE_TENANT_ID           - Azure AD tenant ID
#   AZURE_SUBSCRIPTION_ID     - Azure subscription ID
#   AZURE_RESOURCE_GROUP      - Resource group name (e.g., rg-apolo-teams)
#   AZURE_REGION              - Region (e.g., eastus2, brazilsouth)
#   ACR_NAME                  - Azure Container Registry name (e.g., apoloteamsacr)
#   DATABASE_URL              - PostgreSQL connection string
#   JWT_SECRET                - JWT signing secret
# =============================================================================

name: Deploy to Azure

on:
  push:
    branches: [main]

env:
  CONTAINER_APP_NAME: apolo-teams
  IMAGE_NAME: apolo-teams

concurrency:
  group: deploy-azure
  cancel-in-progress: false

jobs:
  deploy:
    name: Build & Deploy to Azure
    runs-on: ubuntu-latest
    if: github.event_name == 'push'

    steps:
      - uses: actions/checkout@v4

      # ── Authenticate with Azure ────────────────────────────────────────────
      - name: Login to Azure
        uses: azure/login@v2
        with:
          creds: '{"clientId":"${{ secrets.AZURE_CLIENT_ID }}","clientSecret":"${{ secrets.AZURE_CLIENT_SECRET }}","subscriptionId":"${{ secrets.AZURE_SUBSCRIPTION_ID }}","tenantId":"${{ secrets.AZURE_TENANT_ID }}"}'

      # ── Build & Push to Azure Container Registry ───────────────────────────
      - name: Login to ACR
        run: az acr login --name ${{ secrets.ACR_NAME }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: |
            ${{ secrets.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ github.sha }}
            ${{ secrets.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # ── Deploy to Container Apps ───────────────────────────────────────────
      - name: Deploy to Azure Container Apps
        uses: azure/container-apps-deploy-action@v1
        with:
          resourceGroup: ${{ secrets.AZURE_RESOURCE_GROUP }}
          containerAppName: ${{ env.CONTAINER_APP_NAME }}
          imageToDeploy: ${{ secrets.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ github.sha }}

      - name: Get application URL
        run: |
          FQDN=$(az containerapp show \
            --name ${{ env.CONTAINER_APP_NAME }} \
            --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
            --query "properties.configuration.ingress.fqdn" -o tsv)
          echo "## Deployed to Azure Container Apps" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** https://${FQDN}" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
